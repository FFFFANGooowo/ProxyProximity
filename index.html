<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通用API代理测试工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 25px;
            width: 90%;
            max-width: 900px;
        }
        h1 {
            color: #4a90e2;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .section h2 {
            margin-top: 0;
            color: #555;
            font-size: 1.2em;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #357abd;
        }
        .chat-container {
            border: 1px solid #ddd;
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            max-width: 80%;
        }
        .message.user {
            background-color: #e3f2fd;
            margin-left: auto;
        }
        .message.assistant {
            background-color: #f0f0f0;
            margin-right: auto;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            resize: vertical;
            font-size: 1em;
            min-height: 60px;
        }
        .model-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .loading {
            color: #555;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>通用API代理测试工具</h1>
        
        <div class="section">
            <h2>配置信息</h2>
            <div>
                <label for="apiKey">API密钥:</label>
                <input type="password" id="apiKey" placeholder="请输入你的API密钥">
            </div>
            <div style="margin-top: 15px;">
                <label for="apiBaseUrl">API基础地址:</label>
                <input type="text" id="apiBaseUrl" placeholder="例如: api.openai.com" value="api.openai.com">
            </div>
        </div>
        
        <div class="section">
            <h2>模型选择</h2>
            <div>
                <label for="modelSelect">选择模型:</label>
                <select id="modelSelect">
                    <option value="">-- 请选择模型 --</option>
                </select>
            </div>
            <div style="margin-top: 15px;">
                <label for="modelInput">或输入模型ID:</label>
                <input type="text" id="modelInput" placeholder="例如: gpt-3.5-turbo">
            </div>
            <div class="model-actions">
                <button onclick="fetchModels()">获取模型列表</button>
            </div>
            <div id="modelError" class="error" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>聊天测试</h2>
            <div class="chat-container" id="chatContainer">
                <!-- 聊天消息将在这里显示 -->
            </div>
            <div>
                <textarea id="userInput" placeholder="输入你的消息..."></textarea>
            </div>
            <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
                <button onclick="sendMessage()">发送消息</button>
            </div>
            <div id="chatError" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        let chatHistory = [];
        
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.style.display = 'block';
            errorElement.innerHTML = message;
        }
        
        function clearError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.style.display = 'none';
            errorElement.innerHTML = '';
        }
        
        function updateChat(message, isUser) {
            const chatContainer = document.getElementById('chatContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isUser ? 'user' : 'assistant'}`;
            messageElement.textContent = message;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function updateModelList(models) {
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.innerHTML = '<option value="">-- 请选择模型 --</option>';
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.id;
                modelSelect.appendChild(option);
            });
        }
        
        function getApiUrl(endpoint) {
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            return `${window.location.protocol}//${window.location.host}/${apiBaseUrl}/${endpoint}`;
        }
        
        function getApiKey() {
            return document.getElementById('apiKey').value.trim();
        }
        
        async function fetchModels() {
            clearError('modelError');
            const apiKey = getApiKey();
            if (!apiKey) {
                showError('modelError', '错误：请提供API密钥。');
                return;
            }
            const url = getApiUrl('v1/models');
            try {
                document.getElementById('modelError').textContent = '正在获取模型列表...';
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP错误！状态码: ${response.status}<br>详细信息: ${errorText}`);
                }
                const data = await response.json();
                if (data.data && Array.isArray(data.data)) {
                    updateModelList(data.data);
                    document.getElementById('modelError').textContent = '';
                } else {
                    throw new Error(`意外的响应格式: 没有找到模型数据<br>完整响应: ${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                showError('modelError', `获取模型列表失败:<br>${error.message}`);
            }
        }
        
        function sendMessage() {
            clearError('chatError');
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            if (!message) {
                showError('chatError', '错误：请输入消息内容。');
                return;
            }
            const apiKey = getApiKey();
            if (!apiKey) {
                showError('chatError', '错误：请提供API密钥。');
                return;
            }
            const model = document.getElementById('modelSelect').value || document.getElementById('modelInput').value;
            if (!model) {
                showError('chatError', '错误：请选择或输入模型ID。');
                return;
            }
            
            updateChat(message, true);
            userInput.value = '';
            
            chatHistory.push({ role: 'user', content: message });
            
            const url = getApiUrl('v1/chat/completions');
            const payload = {
                model: model,
                messages: chatHistory,
                stream: true
            };
            
            fetchSSE(url, payload, apiKey);
        }
        
        function fetchSSE(url, payload, apiKey) {
            const chatContainer = document.getElementById('chatContainer');
            const messageElement = document.createElement('div');
            messageElement.className = 'message assistant';
            messageElement.textContent = '';
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            let buffer = '';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP错误！状态码: ${response.status}`);
                }
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                
                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            try {
                                const jsonData = JSON.parse(buffer);
                                if (jsonData.choices && jsonData.choices[0].message) {
                                    const content = jsonData.choices[0].message.content || '';
                                    messageElement.textContent = content;
                                    chatHistory.push({ role: 'assistant', content: content });
                                }
                            } catch (e) {
                                if (buffer.trim()) {
                                    showError('chatError', `解析最终响应失败:<br>错误信息: ${e.message}<br>原始数据: ${buffer}`);
                                }
                            }
                            return;
                        }
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6).trim();
                                if (data === '[DONE]') {
                                    chatHistory.push({ role: 'assistant', content: buffer });
                                    return;
                                }
                                try {
                                    const jsonData = JSON.parse(data);
                                    if (jsonData.choices && jsonData.choices[0].delta && jsonData.choices[0].delta.content) {
                                        const content = jsonData.choices[0].delta.content;
                                        buffer += content;
                                        messageElement.textContent = buffer;
                                        chatContainer.scrollTop = chatContainer.scrollHeight;
                                    }
                                } catch (e) {
                                    showError('chatError', `解析SSE数据失败:<br>错误信息: ${e.message}<br>原始数据行: ${data}`);
                                }
                            }
                        }
                        readStream();
                    }).catch(error => {
                        showError('chatError', `读取流数据失败:<br>错误信息: ${error.message}`);
                    });
                }
                readStream();
            }).catch(error => {
                showError('chatError', `请求聊天API失败:<br>错误信息: ${error.message}`);
            });
        }
    </script>
</body>
</html>
